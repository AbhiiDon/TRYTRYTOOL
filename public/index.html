<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot Configuration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .success-message {
            margin-top: 20px;
            font-weight: bold;
            color: green;
        }
        .input-section {
            margin-top: 20px;
        }
        #groupList {
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>WhatsApp Bot Configuration</h1>

    <form id="botForm">
        <label for="phoneNumber">Phone Number (e.g., +918302788872):</label><br>
        <input type="text" id="phoneNumber" name="phoneNumber" required><br><br>
        
        <input type="submit" value="Get Pairing Code">
    </form>

    <div class="pairing-code" id="pairingCodeContainer" style="display:none;">
        Pairing Code: <span id="pairingCode"></span>
    </div>

    <div class="success-message" id="successMessage" style="display:none;">
        Login Successful! You can now configure your bot settings.
    </div>

    <button id="fetchGroupList" style="display:none;">Fetch Group List</button>
    <div id="groupList">
        <h3>Available Groups:</h3>
        <ul id="groupListItems"></ul>
    </div>

    <div class="input-section" id="runConfig" style="display:none;">
        <label for="runCount">How many times to run the bot:</label><br>
        <input type="number" id="runCount" name="runCount" min="1" required><br><br>

        <div id="inputFields"></div>
        
        <label for="interval">Time Interval (seconds):</label><br>
        <input type="number" id="interval" name="interval" min="1" required><br><br>

        <label for="messageFile">Upload Message File:</label><br>
        <input type="file" id="messageFile" name="messageFile" required><br><br>

        <button id="startBot">Start Bot</button>
    </div>

    <script>
        document.getElementById("botForm").addEventListener("submit", function(event) {
            event.preventDefault(); // Prevent form submission

            const phoneNumber = document.getElementById("phoneNumber").value;

            // Send the phone number to the server
            fetch("/get-pairing-code", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ phoneNumber })
            })
            .then(response => response.json())
            .then(data => {
                // Display the pairing code
                document.getElementById("pairingCode").innerText = data.pairingCode;
                document.getElementById("pairingCodeContainer").style.display = "block";

                // Display success message
                document.getElementById("successMessage").style.display = "block";

                // Show the run configuration section
                document.getElementById("runConfig").style.display = "block";
                document.getElementById("fetchGroupList").style.display = "block"; // Show button to fetch groups
            })
            .catch(error => console.error("Error:", error));
        });

        document.getElementById("fetchGroupList").addEventListener("click", function() {
            fetch("/get-group-list")
                .then(response => response.json())
                .then(groups => {
                    const groupListItems = document.getElementById("groupListItems");
                    groupListItems.innerHTML = ""; // Clear previous group items

                    groups.forEach(group => {
                        const listItem = document.createElement("li");
                        listItem.textContent = `${group.name} (ID: ${group.id})`;
                        groupListItems.appendChild(listItem);
                    });

                    document.getElementById("groupList").style.display = "block"; // Show group list
                })
                .catch(error => console.error("Error:", error));
        });

        document.getElementById("runCount").addEventListener("input", function() {
            const count = this.value;
            const inputFieldsDiv = document.getElementById("inputFields");
            inputFieldsDiv.innerHTML = ""; // Clear previous inputs

            for (let i = 0; i < count; i++) {
                const groupInput = document.createElement("div");
                groupInput.innerHTML = `
                    <label for="groupOrNumber${i}">Group ID / Phone Number ${i + 1}:</label><br>
                    <input type="text" id="groupOrNumber${i}" required><br><br>
                `;
                inputFieldsDiv.appendChild(groupInput);
            }
        });

        document.getElementById("startBot").addEventListener("click", function() {
            const runCount = document.getElementById("runCount").value;
            const interval = document.getElementById("interval").value;
            const messageFile = document.getElementById("messageFile").files[0];

            const numbersOrGroups = [];
            for (let i = 0; i < runCount; i++) {
                const numberOrGroup = document.getElementById(`groupOrNumber${i}`).value;
                numbersOrGroups.push(numberOrGroup);
            }

            const formData = new FormData();
            formData.append("runCount", runCount);
            formData.append("interval", interval);
            formData.append("messageFile", messageFile);
            numbersOrGroups.forEach((value, index) => {
                formData.append(`numberOrGroup${index}`, value);
            });

            fetch("/start-bot", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                alert("Bot started successfully!");
                console.log(data);
            })
            .catch(error => console.error("Error:", error));
        });
    </script>
</body>
</html>
